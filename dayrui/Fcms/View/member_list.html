{template "header.html"}


{php echo \Phpcmf\Service::L('Field')->get('select')->get_select_search_code();}
<div class="right-card-box">
<div class="row table-search-tool">
    <form action="{SELF}" method="get">
        {dr_form_search_hidden()}
        {if $status}
        <div class="col-md-12 col-sm-12">
            <label>
                <select name="status[]" class="form-control bs-select" data-title="{dr_lang('账号状态')}" multiple="multiple">
                    {loop $status $i $t}
                    <option value="{$i}" {if dr_in_array($i, $param.status)}selected{/if}>{dr_lang($t)}</option>
                    {/loop}
                </select>
            </label>
        </div>
        {/if}
        <div class="col-md-12 col-sm-12">
            <label style="min-width: 200px;">
                <select name="groupid[]" class="form-control bs-select" multiple="multiple" data-title="{dr_lang('用户组')}" data-actions-box="true">
                    {loop $group $t}
                    <option value="{$t.id}" {if dr_in_array($t.id, $param.groupid)}selected{/if}>{dr_lang($t.name)}</option>
                    {/loop}
                </select>
            </label>
        </div>
        <div class="col-md-12 col-sm-12">
            <label>
                <select name="field" class="form-control">
                    <option value="id"> Id </option>
                    {loop $field $t}
                    {if dr_is_admin_search_field($t)}
                    <option value="{$t.fieldname}" {if $param.field==$t.fieldname}selected{/if}>{dr_lang($t.name)}</option>
                    {/if}
                    {/loop}
                </select>
            </label>
            <label><i class="fa fa-caret-right"></i></label>
            <label><input type="text" class="form-control" placeholder="" value="{$param['keyword']}" name="keyword" /></label>
        </div>


        <div class="col-md-12 col-sm-12">
            <label><button type="submit" class="btn blue btn-sm onloading" name="submit" > <i class="fa fa-search"></i> {dr_lang('搜索')}</button></label>
        </div>
    </form>
</div>

<form class="form-horizontal" role="form" id="myform">
    {dr_form_hidden()}
    <div class="table-scrollable">
        <table class="table table-striped table-bordered table-hover table-checkable dataTable">
            <thead>
            <tr class="heading">
                {if $ci->_is_admin_auth('member/del') || $ci->_is_admin_auth('member/edit') || $ci->_is_admin_auth('member_verify/edit')}
                <th class="myselect">
                    <label class="mt-table mt-checkbox mt-checkbox-single mt-checkbox-outline">
                        <input type="checkbox" class="group-checkable" data-set=".checkboxes" />
                        <span></span>
                    </label>
                </th>
                {/if}
                <th style="text-align:center" width="60" class="{dr_sorting('id')}" name="id">{dr_lang('头像')}</th>
                {loop $list_field $i $t}
                <th {if $t.width} width="{$t.width}"{/if} {if $t.center} style="text-align:center"{/if} class="{dr_sorting($i)}" name="{$i}">{dr_lang($t.name)}</th>
                {/loop}
                <th>{dr_lang('操作')}</th>
            </tr>
            </thead>
            <tbody>
            {loop $list $t}
            <tr class="odd gradeX" id="dr_row_{$t.id}">
                {if $ci->_is_admin_auth('member/del') || $ci->_is_admin_auth('member/edit') || $ci->_is_admin_auth('member_verify/edit')}
                <td class="myselect">
                    <label class="mt-table mt-checkbox mt-checkbox-single mt-checkbox-outline">
                        <input type="checkbox" class="checkboxes" name="ids[]" value="{$t.id}" />
                        <span></span>
                    </label>
                </td>
                {/if}
                <td style="text-align:center"> <a class="fc_member_show" href="javascript:;" uid="{$t.id}"><img class="img-circle" src="{dr_avatar($t.id)}" style="width:30px;height:30px"></a> </td>
                {loop $list_field $i $tt}
                <td {if $tt.center} class="table-center" style="text-align:center"{/if}>{dr_list_function($tt.func, $t[$i], $param, $t, $member_list_field[$i])}</td>
                {/list}
                <td>
                    <label><a href="javascript:dr_iframe_show('{dr_lang('登录记录')}', '{dr_url($uriprefix.'/login_index', ['id'=>$t.id])}', '80%')" class="btn btn-xs blue"> <i class="fa fa-calendar"></i> {dr_lang('记录')}</a></label>
                    {if $ci->_is_admin_auth('member/edit')}
                    <label><a href="{dr_url($uriprefix.'/edit', ['id'=>$t.id])}" class="btn btn-xs green"> <i class="fa fa-edit"></i> {dr_lang('资料')}</a></label>
                    <label><a href="javascript:dr_iframe('{dr_lang('设置用户组')}', '{dr_url($uriprefix.'/group_edit', ['id'=>$t.id])}', '60%')" class="btn btn-xs dark"> <i class="fa fa-users"></i> {dr_lang('权限')}</a></label>
                    {/if}

                    <label><a href="{dr_url('api/alogin', ['id'=>$t.id])}" class="btn btn-xs red" target="_blank"> <i class="fa fa-user"></i> {dr_lang('登录')}</a></label>
                </td>
            </tr>
            {/loop}
            </tbody>
        </table>
    </div>

         <div class="row fc-list-footer table-checkable ">
             <div class="col-md-7 fc-list-select">
                {if $ci->_is_admin_auth('member/del') || $ci->_is_admin_auth('member/edit') || $ci->_is_admin_auth('member_verify/edit')}
                <label class="mt-table mt-checkbox mt-checkbox-single mt-checkbox-outline">
                    <input type="checkbox" class="group-checkable" data-set=".checkboxes" />
                    <span></span>
                </label>
                {/if}
                {if $ci->_is_admin_auth('member/del')}
                <label><button type="button" onclick="dr_ajax_option_user('{dr_url('member/del')}', 1)" class="btn red btn-sm"> <i class="fa fa-trash"></i> {dr_lang('删除')}</button></label>
                {/if}
                {if $is_verify && $ci->_is_admin_auth('member_verify/edit')}
                <label><button type="button" onclick="dr_ajax_option('{dr_url('member_verify/edit')}', '{dr_lang('你确定要通过审核吗？')}', 1)" class="btn blue btn-sm"> <i class="fa fa-check-square-o"></i> {dr_lang('通过')}</button></label>
                {/if}
                {if $ci->_is_admin_auth('member/edit')}
                <label>
                    <select name="groupid" class="form-control">
                        <option value=""> -- </option>
                        {loop $group $t}
                        <option value="{$t.id}" {if $param.groupid==$t.id}selected{/if}>{dr_lang($t.name)}</option>
                        {/loop}
                    </select>
                </label>
                <label><button type="button" onclick="dr_ajax_option('{dr_url('member/group_all_edit')}', '{dr_lang('你确定要这样操作吗？')}', 1)" class="btn green btn-sm"> <i class="fa fa-edit"></i> {dr_lang('更改')}</button></label>
                {/if}
             </div>
             <div class="col-md-5 fc-list-page">
                 {$mypages}
             </div>
         </div>
</form>
<script>
    $(function () {
        var up = 0;
        $('.dr_username_phone').each(function () {
            var html = $(this).html();
            if (html.length > 44) {
                up = 1;
            }
        });
        if (up == 0) {
            $('.dr_username_phone').remove();
        }
    });
    // ajax 批量操作确认
    function dr_ajax_option_user(url, remove) {

        layer.confirm(
            '{dr_lang('全部删除: 删除账号会联动删除所发布的内容和附件。')}<br>'+
            '{dr_lang('删除账号: 删除账号相关信息时不会影响该账号的相关数据和附件。')}<br>',
            {
                icon: 3,
                shade: 0,
                area: ['500px', '220px'],
                title: '{dr_lang('确认删除')}',
                btn: ['{dr_lang('全部删除')}','{dr_lang('只删除账号')}', lang['esc']]
            }, function(index){
                layer.close(index);
                var loading = layer.load(2, {
                    shade: [0.3,'#fff'], //0.1透明度的白色背景
                    time: 5000
                });
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url: url+'&sync=1',
                    data: $("#myform").serialize(),
                    success: function(json) {
                        layer.close(loading);
                        if (json.code) {
                            if (remove) {
                                // 批量移出去
                                var ids = json.data.ids;
                                if (typeof ids != "undefined" ) {
                                    console.log(ids);
                                    for ( var i = 0; i < ids.length; i++){
                                        $("#dr_row_"+ids[i]).remove();
                                    }
                                }
                            }
                            if (json.data.htmlfile) {
                                // 执行生成htmljs
                                $.ajax({
                                    type: "GET",
                                    url: json.data.htmlfile,
                                    dataType: "jsonp",
                                    success: function(json){ },
                                    error: function(){ }
                                });
                            }
                            if (json.data.url) {
                                setTimeout("window.location.href = '"+json.data.url+"'", 2000);
                            } else {
                                setTimeout("window.location.reload(true)", 3000)
                            }
                        }
                        dr_cmf_tips(json.code, json.msg);
                    },
                    error: function(HttpRequest, ajaxOptions, thrownError) {
                        dr_ajax_alert_error(HttpRequest, ajaxOptions, thrownError)
                    }
                });
            }, function(index){
                layer.close(index);
                var loading = layer.load(2, {
                    shade: [0.3,'#fff'], //0.1透明度的白色背景
                    time: 5000
                });
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url: url+'&sync=0',
                    data: $("#myform").serialize(),
                    success: function(json) {
                        layer.close(loading);
                        if (json.code) {
                            if (remove) {
                                // 批量移出去
                                var ids = json.data.ids;
                                if (typeof ids != "undefined" ) {
                                    console.log(ids);
                                    for ( var i = 0; i < ids.length; i++){
                                        $("#dr_row_"+ids[i]).remove();
                                    }
                                }
                            }
                            if (json.data.htmlfile) {
                                // 执行生成htmljs
                                $.ajax({
                                    type: "GET",
                                    url: json.data.htmlfile,
                                    dataType: "jsonp",
                                    success: function(json){ },
                                    error: function(){ }
                                });
                            }
                            if (json.data.url) {
                                setTimeout("window.location.href = '"+json.data.url+"'", 2000);
                            } else {
                                setTimeout("window.location.reload(true)", 3000)
                            }
                        }
                        dr_cmf_tips(json.code, json.msg);
                    },
                    error: function(HttpRequest, ajaxOptions, thrownError) {
                        dr_ajax_alert_error(HttpRequest, ajaxOptions, thrownError)
                    }
                });

            });
    }
</script>
</div>

{template "footer.html"}